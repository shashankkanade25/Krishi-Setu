<!-- Navigation -->
<nav>
    <div class="container">
        <div class="nav-content">
            <a href="/home" class="logo">
                <img src="/images/krishi-setu-logo.png" alt="कृषी-सेतू" class="logo-img">
            </a>
            
            <!-- Mobile Menu Toggle -->
            <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Toggle menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
            
            <!-- Desktop Search -->
            <div class="search-container desktop-search">
                <input type="text" id="searchInput" class="search-bar" placeholder="Search for fresh produce..." autocomplete="off">
                <span class="search-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.35-4.35"/>
                    </svg>
                </span>
                <div id="searchResults" class="search-results"></div>
            </div>
            
            <!-- Desktop Navigation -->
            <div class="nav-right" id="navMenu">
                <!-- Mobile Search -->
                <div class="search-container mobile-search">
                    <input type="text" id="searchInputMobile" class="search-bar" placeholder="Search products..." autocomplete="off">
                    <span class="search-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="m21 21-4.35-4.35"/>
                        </svg>
                    </span>
                    <div id="searchResultsMobile" class="search-results"></div>
                </div>
                
                <a href="#contact" class="nav-link">
                    <i class="fas fa-phone-alt"></i>
                    <span>Contact Us</span>
                </a>
                
                <a href="/cart" class="icon-link cart-link">
                    <svg class="nav-icon" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="8" cy="21" r="1"/>
                        <circle cx="19" cy="21" r="1"/>
                        <path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/>
                    </svg>
                    <span>My Cart</span>
                    <span class="cart-count" style="display: none;">0</span>
                </a>
                
                <div class="profile-dropdown" id="profileDropdown">
                    <a href="javascript:void(0)" class="icon-link" onclick="toggleDropdown(event)">
                        <svg class="nav-icon" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                        <span>Account</span>
                    </a>
                    <div class="profile-menu" id="profileMenu">
                        <a href="/profile">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                            My Profile
                        </a>
                        <a href="/orders">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 16h6"/><path d="M16 20h6"/><path d="M4 4h16c1.1 0 2 .9 2 2v4c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/></svg>
                            My Orders
                        </a>
                        <a href="/settings">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72 1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
                            Settings
                        </a>
                        <a href="/logout">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                            Logout
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</nav>

<!-- Mobile Menu Overlay -->
<div class="mobile-menu-overlay" id="mobileMenuOverlay"></div>

<script>
    // Mobile Menu Toggle
    const mobileMenuToggle = document.getElementById('mobileMenuToggle');
    const navMenu = document.getElementById('navMenu');
    const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
    
    function toggleMobileMenu() {
        mobileMenuToggle.classList.toggle('active');
        navMenu.classList.toggle('active');
        mobileMenuOverlay.classList.toggle('active');
        document.body.classList.toggle('menu-open');
    }
    
    if (mobileMenuToggle) {
        mobileMenuToggle.addEventListener('click', toggleMobileMenu);
    }
    
    if (mobileMenuOverlay) {
        mobileMenuOverlay.addEventListener('click', toggleMobileMenu);
    }
    
    // Close mobile menu when clicking on a link
    navMenu.querySelectorAll('a').forEach(link => {
        link.addEventListener('click', function() {
            if (navMenu.classList.contains('active')) {
                toggleMobileMenu();
            }
        });
    });

    function toggleDropdown(event) {
        event.preventDefault();
        event.stopPropagation();
        const dropdown = document.getElementById('profileDropdown');
        dropdown.classList.toggle('active');
    }
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
        const dropdown = document.getElementById('profileDropdown');
        if (!dropdown.contains(event.target)) {
            dropdown.classList.remove('active');
        }
    });

    // Update cart count on page load
    function updateCartCount() {
        fetch('/cart/count')
            .then(response => response.json())
            .then(data => {
                const cartBadges = document.querySelectorAll('.cart-count');
                cartBadges.forEach(badge => {
                    badge.textContent = data.count;
                    if (data.count > 0) {
                        badge.style.display = 'flex';
                    } else {
                        badge.style.display = 'none';
                    }
                });
            })
            .catch(error => console.error('Error updating cart count:', error));
    }
    
    // Update on page load
    updateCartCount();

    // Search functionality for both desktop and mobile
    function setupSearch(inputId, resultsId) {
        const searchInput = document.getElementById(inputId);
        const searchResults = document.getElementById(resultsId);
        let searchTimeout;

        if (!searchInput || !searchResults) return;

        searchInput.addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            const query = e.target.value.trim();

            if (query.length < 2) {
                searchResults.innerHTML = '';
                searchResults.style.display = 'none';
                return;
            }

            searchTimeout = setTimeout(() => {
                fetch(`/api/search?q=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        displaySearchResults(data.results, searchResults, query);
                    })
                    .catch(error => console.error('Search error:', error));
            }, 300);
        });

        // Close search results when clicking outside
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.style.display = 'none';
            }
        });

        searchInput.addEventListener('focus', function() {
            if (searchResults.innerHTML) {
                searchResults.style.display = 'block';
            }
        });
    }

    // Setup search for both desktop and mobile
    setupSearch('searchInput', 'searchResults');
    setupSearch('searchInputMobile', 'searchResultsMobile');

    function displaySearchResults(results, container, query) {
        if (!results || results.length === 0) {
            container.innerHTML = '<div class="no-results"><i class="fas fa-search"></i><p>No products found</p></div>';
            container.style.display = 'block';
            return;
        }

        const html = results.map(product => `
            <div class="search-result-item" onclick="goToProduct('${product.category}', '${product.name.replace(/'/g, "\\'")}')">
                <img src="${product.image}" alt="${product.name}">
                <div class="result-info">
                    <h4>${highlightQuery(product.name, query)}</h4>
                    <p class="result-category">${product.category}</p>
                    <p class="result-price">₹${product.price}</p>
                </div>
            </div>
        `).join('');

        container.innerHTML = html;
        container.style.display = 'block';
    }

    function highlightQuery(text, query) {
        if (!query) return text;
        const regex = new RegExp(`(${query})`, 'gi');
        return text.replace(regex, '<span class="highlight">$1</span>');
    }

    function goToProduct(category, productName) {
        // Redirect to products page with category and search for the product
        window.location.href = `/products?category=${category}&search=${encodeURIComponent(productName)}`;
    }

</script>
